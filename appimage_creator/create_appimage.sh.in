#!/bin/bash

DST=~/DABstarAppImage

mkdir -p $DST

mkdir -p $DST/appdir/usr/bin
mkdir -p $DST/appdir/usr/share/applications
mkdir -p $DST/appdir/usr/share/icons/hicolor/128x128/apps/
mkdir -p $DST/appdir/usr/share/icons/hicolor/256x256/apps/

cp dabstar.desktop            $DST/appdir/usr/share/applications
cp ../res/dabstar128x128.png  $DST/appdir/
cp ../res/dabstar256x256.png  $DST/appdir/
cp ../res/dabstar128x128.png  $DST/appdir/usr/share/icons/hicolor/128x128/apps/
cp ../res/dabstar256x256.png  $DST/appdir/usr/share/icons/hicolor/256x256/apps/

cd $DST || exit

# from here the build folder with the build has to be exist in the folder $DST
cp build/dabstar appdir/usr/bin/

wget -q --show-progress -c "https://github.com/probonopd/linuxdeployqt/releases/download/continuous/linuxdeployqt-continuous-x86_64.AppImage"
chmod a+x linuxdeployqt*.AppImage

./linuxdeployqt*.AppImage ./appdir/usr/share/applications/* -appimage -no-translations

# if all worked fine add the version number to the generated filename
if [ $? -eq 0 ]; then
  echo "linuxdeployqt runs successfully"
  APP_NAME="@PROJECT_NAME@"
  APP_VERS="@PROJECT_VERSION@"
  APP_ARCH="x86_64"
  FN_SRC="${APP_NAME}-${APP_ARCH}.AppImage"
  FN_DST="${APP_NAME}-${APP_VERS}-${APP_ARCH}.AppImage"
  mv "$FN_SRC" "$FN_DST"
  echo "Renamed file $FN_SRC to $FN_DST"
else
  echo "linuxdeployqt failed with $?"
fi